extends ../layout
block content
	include ../mixins/menu.jade
	include ../mixins/locationChooser.jade
	include ../mixins/forms/placeForm.jade
	include ../mixins/forms/loginForm.jade
	
	mixin menu('place')
	mixin locationChooser()


	div.container-fluid
		div.row-fluid
			div.span4
				div#mymap
			div.span8
				div
					.fuelux
						div#newsfeedContainer
							- if (message)
								each msg in message
									div.alert.fade.in
										button.close(type="button",data-dismiss="alert") x
										strong= msg
							table#MyGrid.table.table-bordered.datagrid
								thead
									tr
										th
											span.datagrid-header-title Liste des places
											.datagrid-header-left
												button.btn#btnAdd
													i.icon-plus
											.datagrid-header-right
												.input-append.search
													input.input-medium(type='text', placeholder='Search')
													button.btn
														i.icon-search
									tr
										td(colspan=4)
											.btn-group
												button.btn.btn-danger.validerPlaces Valider
												button.btn.btn-danger.dropdown-toggle(data-toggle='dropdown')
													span.caret
												ul.dropdown-menu
													li
														a.supprimerPlaces Supprimer
								tfoot
									tr
										th
											.datagrid-footer-left(style='display: none;')
												.grid-controls
													span
														span.grid-start
														| -
														span.grid-end
														| of
														span.grid-count
													select.grid-pagesize
														option 10
														option 20
														option 50
														option 100
													span Per Page
											.datagrid-footer-right(style='display: none;')
												.grid-pager
													button.btn.grid-prevpage
														i.icon-chevron-left
													span Page
													.input-append.dropdown.combobox.dropup
														input.span1(type='text')
														button.btn(data-toggle='dropdown')
															i.caret
														ul.dropdown-menu
													span
														| of
														span.grid-pages
													button.btn.grid-nextpage
														i.icon-chevron-right
							div
								mixin placeForm()

				
	script
	
		/*INIT*/
		var conf = !{conf};
		var user = [!{user}];
		var logged = 0;
		//var user = JSON.parse(JSON.stringify({!{user}}));
		
		var curPos = {'x':0,'y':0,'z':0};
		var geolocalized = 0;
		var infowindow = null;
		var bounds = new Array();
		var markers = [];
		var infoArray = [];
		var markerLocation = null;
		var yakcatArray = [];
		var placeArray = [];
		var hashtag = [];
		var hashtagTmp = [];
			
		var markerClustererOptions = {gridSize:30,maxZoom: 17};
		var markerCluster = null;
		var heat = 3;
		//var type = [1];
		var type = [!{type}];
		
		var infoContent = '';
		var rule = new RegExp('#([^\\s]*)','g');
		var rule2 = new RegExp('[#]','g');
		var postFlag = 0;
		var listenerHandle = null;

		var ApiDataSource = function (options) {
			this._formatter = options.formatter;
			this._columns = options.columns;
		};

		ApiDataSource.prototype = {

			columns: function () {
				return this._columns;
			},

			data: function (options, callback) {

				var url = '/api/places';
				var self = this;

				if (!options.search) {
					options.search = "^";
				}

				url += '/' + (options.pageIndex + 1);
				url += '/' + options.pageSize;
				url += '/' + options.search;
				
				if (options.sortProperty) {
					url += '/' + options.sortProperty;
					url += '/' + options.sortDirection;
				}
				else {
					url += '/title/asc';
				}

				$.ajax(url, {
					type: 'GET'
				}).done(function (response) {
					// Prepare data to return to Datagrid
					var data = response.place;
					var count = response.count;
					var startIndex = (response.pageIndex - 1) * response.pageSize;
					var endIndex = parseInt(startIndex) + parseInt(response.pageSize);
					var end = (endIndex > count) ? count : endIndex;
					var page = parseInt(response.pageIndex);
					var pages = Math.ceil(response.count / response.pageSize);
					var start = startIndex + 1;

					if (self._formatter) self._formatter(data);

					callback({ data: data, start: start, end: end, count: count, pages: pages, page: page });

				});
			}
		};

		$('#MyGrid').datagrid({
			dataSource: new ApiDataSource({
				columns: [{
					property: 'checked',
					label: '<input id="selectAllPlaces" type="checkbox" />',
					sortable: false
				},
				{
					property: 'title',
					label: 'Titre',
					sortable: true
				},
				{
					property: 'user',
					label: 'Utilisateur',
					sortable: true
				},
				{
					property: 'address',
					label: 'Ville',
					sortable: true
				}],
				formatter: function (items) {
					$.each(items, function (index, item) {
						item.checked = makeCheckBox(item);
						item.title = fillContent(item);
						item.address = item.address['city'];
						if (item.user) {
							console.log(item.user);
							item.user = formatUser(item);
						}
						else
							item.user = "Yakwala";
					});
				}
			})
		});

		function makeCheckBox(item) {
			return '<input type="checkbox" class="selectYakPlace" value="' + item._id + '"/>';
		}

		function fillContent(item) {
			var res;

			res = '<a class="editPlace" id="' + item._id + '" href="#">';
			var size = 90;
			res += '<div class="text-info">' + item.title + '</div><small>';
			if (item.content.length > size)
				res += '<em>' + item.content.slice(0, size) + '...</em>';
			else
				res += '<em>' + item.content + '</em>';
			if (item.outGoingLink)
				res += '<br><a href=\''+ item.outGoingLink + '\'>' + item.outGoingLink + '</a>';
			res += '</small></a>';
			return res;
		}

		// Edit Place function
		$(".editPlace").live('click', function() 
		{
			event.preventDefault();
			listenerHandle = google.maps.event.addListener(map, 'click', function(event) {
				getformattedAddress(event.latLng);
				placeMarker(event.latLng,markerLocation);
				google.maps.event.addListener(markerLocation, 'dragend', function() {
					var position = markerLocation.getPosition();
					$('#placeForm #latitude').val(position.lat());	
					$('#placeForm #longitude').val(position.lng());	
					
					getformattedAddress(position);
					
				});		
			});
			
			$("#MyGrid").hide();
			// We remove the error class when we open a form for editing a place
			$('#placeForm #titleGroup').removeClass("error");
			$('#placeForm #contentGroup').removeClass("error");
			$('#placeForm #licenceGroup').removeClass("error");
			$('#placeForm #origineGroup').removeClass("error");
			$('#placeForm #adresseGroup').removeClass("error");
			$("#placeForm").fadeIn();
			$("#btnBack").fadeIn();
			
			$("#placeForm legend").html("Editer une place");
			$("#placeForm #objid").val(this.id);
			
			var url = '/api/places/'+this.id;
			
			// We search for the place in mongo and we fill the form with the place's values
			$.ajax(url, {type: 'GET'}).done(function (response) 
			{
				var place = response.place;	
				$("#placeForm #place").val(place.formatted_address);
				
				var latlng = new google.maps.LatLng(place.location.lat, place.location.lng);
				getformattedAddress(latlng);
				placeMarker(latlng,markerLocation);
				map.setCenter(markerLocation.getPosition());
				$("#placeForm #licence").val(place.licence);		
				$("#placeForm #origine").val(place.origin);
				$("#placeForm #title").val(place.title);		
				$("#placeForm #content").val(place.content);
				$("#placeForm #freetag").val(place.freeTag);
				
				for (var i = 0; i < place.yakCat.length; i++)
				{
					$("label[for='category']").after("<div><i class='icon-remove icon-pointer'  onclick='yakcatArray.cleanArray(\""+obj._id+"\");$(\"#placeForm #yakcatInput\").val(JSON.stringify(yakcatArray));$(this).parent().remove();'></i> "+place.yakCat[i]+"</div>");
				}
				
				$("#placeForm #freetag").val(place.freeTag.join(","));
				if (place.status == 1)
					$("#placeForm #validate").check();
				else
					$("#placeForm #validate").uncheck();
					
				// loading the thumb
				var imag = "<img class='img-rounded' " + "src='" + place.thumb +"' style='width:100px'/>";
				$("#placeForm #picturePreview").html(imag);
			});	
		});
		
		// Add Place function
		$("#btnAdd").click(function() 
		{
			event.preventDefault();
			listenerHandle = google.maps.event.addListener(map, 'click', function(event) {
				getformattedAddress(event.latLng);
				placeMarker(event.latLng,markerLocation);
				google.maps.event.addListener(markerLocation, 'dragend', function() {
					var position = markerLocation.getPosition();
					$('#placeForm #latitude').val(position.lat());	
					$('#placeForm #longitude').val(position.lng());	
					
					getformattedAddress(position);
					
				});		
			});			
			$("#MyGrid").hide();
			$("#placeForm")[0].reset();
			// We remove the error class when we open a form for creating a new place
			$('#placeForm #titleGroup').removeClass("error");
			$('#placeForm #contentGroup').removeClass("error");
			$('#placeForm #licenceGroup').removeClass("error");
			$('#placeForm #origineGroup').removeClass("error");
			$('#placeForm #adresseGroup').removeClass("error");
			$('#placeForm #content').val("");
			$("#placeForm").fadeIn();
			$("#btnBack").fadeIn();
		});
		
		$("#placeForm legend").html("Ajouter une place");


		// Function to go back from adding/editing form to the grid
		$("#btnBack").click(function() {
			$("#MyGrid").fadeIn();
			$("#placeForm").hide();
			$("#btnBack").hide();
			google.maps.event.removeListener(listenerHandle);
			markerLocation.setVisible(false);
		});

		function formatUser(item) {
			var res;
			$.ajax({
				url: '/api/user/'+ item.user,
				dataType: 'json',
				async: false,
				success: function(data) {
					return data.user.name;
				}
			});
		}

		/*
		$("#validation").change(function() {			
			$.getJSON('/api/places/'+ $(this).val(),function(data) {
				$('div#placeContent').html("");
				renderData(data);
			});
		});
		*/

		// Datagrid checkbox
		$(".selectYakPlace").live('change', function() {
			if ($(this).prop('checked') == false)
				$("#selectAllPlaces").prop('checked', false);
		});

		$("#selectAllPlaces").change(function() {
			$(".selectYakPlace").prop('checked', $(this).prop('checked'));
		});

		$(".validerPlaces").live('click', function() {
			var vals = [];
			var i = 0;

			$(".selectYakPlace").each(function(){	
				if ($(this).prop('checked') == true)
					vals[i++] = jQuery(this).val();
			});

			if (vals.length == 0) {
				alert('Aucune place selectionnee.');
				return;
			}

			var url = '/api/places/validate/'+vals.toString();

			$.get(url, function(data) {
				if (data.result == -1)
					alert('Error');
				else {
					alert('Validation de ' + data.result + ' place(s)');
					refreshDatagridAndMenu();
				}
			});

			return vals;
		});

		$(".supprimerPlaces").live('click', function() {
			var vals = [];
			var i = 0;

			$(".selectYakPlace").each(function(){	
				if ($(this).prop('checked') == true)
					vals[i++] = jQuery(this).val();
			});

			if (vals.length == 0) {
				alert('Aucune place selectionnee.');
				return;
			}

			var url = '/api/places/delete/'+vals.toString();

			$.get(url, function(data) {
				if (data.result == -1)
					alert('Error');
				else {
					alert('Suppression de ' + data.result + ' place(s)');
					refreshDatagridAndMenu();
				}
			});

			return vals;
		});


		function refreshDatagridAndMenu () {
			// Temporary refresh method for datagrid
			var $gridsearch = jQuery('#MyGrid').find('.search');
			var search = $gridsearch.find('input').val();
			$gridsearch.trigger('searched', search);
			$.getJSON('/api/validplaces', function(data) {
				$('#placenumber').removeClass('badge badge-important');
				if (data.info != 0)
					$('#placenumber').addClass('badge badge-important').html(data.info);
			});
		}

		
		/*READY FUNCTIONS*/
		$(document).ready(function() {
			/*init*/
			if(user.length){
				user = JSON.parse(JSON.stringify(!{user}));
				logged = 1;
			}
			
			if(logged){
				$.each(user.favplace,function(key,val){
					$('ul#favplacelist').append("<li pointId='"+val._id+"' lat='"+val.location.lat+"' lng='"+val.location.lng+"' class='zoneLoc'><i class='icon-map-marker'></i><span> "+val.name+"</span><i class='icon-remove icon-pointer'  onclick='removefavPlace($(this));'></i></li>");
				});
			}else{
				$('ul#favplacelist').append("<li lat='48.851875' lng='2.356374' class='zoneLoc'><i class='icon-map-marker'></i><span> Paris, France</span></li>");
				$('ul#favplacelist').append("<li lat='43.610787' lng='3.876715' class='zoneLoc'><i class='icon-map-marker'></i><span> Montpellier, France</span></li>");
				$('ul#favplacelist').append("<li lat='50.583346' lng='4.900031' class='zoneLoc'><i class='icon-map-marker'></i><span> Eghézée, Belgique</span></li>");
			}
				
			/*endroits favoris*/
			$('ul#favplacelist').delegate("li.zoneLoc span",'click', function () {
				var lat = parseFloat($(this).parent().attr('lat'));
				var lng = parseFloat($(this).parent().attr('lng'));	
				moveMap(lat,lng);
			});
			
			/*autour de moi*/
			$('#arroundme').click(function(){
				if(logged){
					if(user.location){
						var latLng = new google.maps.LatLng(user.location['lat'],user.location['lng']);
						map.setCenter(latLng);
					}else{
						window.location = '/settings/profile';
					}
				}else
					window.location = '/user/login';
			});
		
			// init news feed
			drawNewsFeed();

			$('#newsfeedContainer').mCustomScrollbar({mouseWheel:true,scrollButtons:{enable:true,scrollType:"continuous",},advanced:{autoExpandHorizontalScroll:true,updateOnContentResize: true,updateOnBrowserResize:true}});
			$(window).resize(function(){drawNewsFeed();});
			
			$('#newsfeed').delegate(".mapHighlighter",'click', function () {
				unhighlightInfo($(this),highlightInfo);
			});

			/*throw the silent updater*/
			setInterval(function() {
				silentMarkerAdder();
			}, 10000);
			
			/*cookies for navigation*/
			if($.cookie("geoloc")){
				curPos = JSON.parse($.cookie("geoloc"));
				google.maps.event.addDomListener(window, 'load', initialize(curPos.x,curPos.y,curPos.z));
			}else{
				if(navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(getHTML5Pos,getErrHTML5Pos);
				}else {
					x = 48.851875;
					y = 2.356374;
					z = 13;
					curPos = {'x':x,'y':y,'z':z};
					google.maps.event.addDomListener(window, 'load', initialize(curPos.x,curPos.y,curPos.z));
				}
			}
			
			
			/*POST EFFECTS*/
			// hashtag creation from title field
			$(".hashtagMaker").keyup(function(event) {
				hashtagTmp = [];
				var inputStrArray = ($('#content').val()+' '+$('#title').val()).split(' ');
				for(i = 0; i< inputStrArray.length;i++){
					if(inputStrArray[i].match(rule)){
						//console.log('PUSH');
						hashtagTmp.push(inputStrArray[i]);
						//console.log(hashtagTmp);
						$('#freetag').val(hashtagTmp.toString().replace(rule2,''));
					}
				}
			});

			$('#placeForm #picture').live('change', function () {
				if (window.FileReader) {
					var fileList = this.files;
					var file = fileList[0];
					var r = new FileReader();
					r.onload = function () {
						var binimage = r.result;
						//console.log(binimage);
						
						binimage1 = binimage.replace('data:'+file.type+';base64,', '');
						var imag = "<img class='img-rounded' " + "src='" + 
						"data:"+file.type+";base64," + binimage1 + "' style='width:100px'/>";
						$("#placeForm #picturePreview").html(imag);
					};
					r.readAsDataURL(file);
				}
				//r.readAsBinaryString(file);
			});
			
			// We validate the form before submitting it
			$('#placeForm').submit(function()
			{
				var err = false;
				if ($('#placeForm #title').val() == "")
				{
					$('#placeForm #titleGroup').addClass("error");
					err = true;
				}
				else
					$('#placeForm #titleGroup').removeClass("error");
				if ($('#placeForm #content').val() == "")
				{
					$('#placeForm #contentGroup').addClass("error");
					err = true;
				}
				else
					$('#placeForm #contentGroup').removeClass("error");
				if ($('#placeForm #licence').val() == "")
				{
					$('#placeForm #licenceGroup').addClass("error");
					err = true;
				}
				else
					$('#placeForm #licenceGroup').removeClass("error");
				if ($('#placeForm #origine').val() == "")
				{
					$('#placeForm #origineGroup').addClass("error");
					err = true;
				}
				else
					$('#placeForm #origineGroup').removeClass("error");
				if (placeArray.length == 0)
				{
					$('#placeForm #adresseGroup').addClass("error");
					err = true;
				}
				else
					$('#placeForm #adresseGroup').removeClass("error");
				
				if (err) 
					return false;
				return true;
			});
			
			markerLocation = new google.maps.Marker({
				visible:false,
				map:map,
				draggable:true,
				icon:'/images/beachflag.png',
				//position:center
			});
				
			$('#placeForm #yakcat').typeahead({
				source: function (typeahead, query) {
					$.ajax({
						url: "/api/cats",				
						success: function(data) {
							typeahead.process(data.cats);
						}
					})},
				property: "title",
				onselect: function(obj) { 
					$("label[for='category']").after("<div><i class='icon-remove icon-pointer'  onclick='yakcatArray.cleanArray(\""+obj._id+"\");$(\"#placeForm #yakcatInput\").val(JSON.stringify(yakcatArray));$(this).parent().remove();'></i> "+obj.title+"</div>");
					$('#placeForm #yakcat').val('').focus();
					yakcatArray.push(obj);
					$("#placeForm #yakcatInput").val(JSON.stringify(yakcatArray));
				}
			});
			
			$('#placeForm #place').typeahead({
				minLength : 3,							
				source: function (typeahead, query) {
					$.ajax({
						url: "/api/places",		
						success: function(data) {
							typeahead.process(data.places);
						}
					})},
				property: "title",
				onselect: function(obj) { 
					$('#placeLabel').first().remove();
					$('#placeForm #btn-place-adder').parent().before("<div id='placeLabel'><i class='icon-remove icon-pointer'  onclick='placeArray.cleanArray(\""+obj._id+"\");$(\"#placeForm #placeInput\").val(JSON.stringify(placeArray));$(this).parent().remove();'></i> "+obj.title+"</div>");
					$('#placeForm #place').val('').focus();
					placeArray.push(obj);
					$("#placeForm #placeInput").val(JSON.stringify(placeArray));
				}
			});
				
			$('#placeForm #btn-place-adder').click(function(){
				
				var addressString = $('#placeForm #place').val();
				if(addressString != "Rechercher..." && addressString != "" && addressString.length > 1){
					var addressQuery = {"address": addressString,"latLng":map.getCenter(),"bounds":map.getBounds()};
					var geocoder = new google.maps.Geocoder();
					geocoder.geocode(addressQuery, function(results, status) {
						if (status == google.maps.GeocoderStatus.OK) {
							map.setCenter(results[0].geometry.location);
							markerLocation.setVisible(true);
							markerLocation.setPosition(results[0].geometry.location);
							placeMarker(results[0].geometry.location,markerLocation);
							var placeGmap = getPlaceFromGmapResult(results[0]);
							placeArray.push(placeGmap);
							$("#placeForm #placeInput").val(JSON.stringify(placeArray));
							$('#placeLabel').first().remove();
							$('#placeForm #btn-place-adder').parent().before("<div id='placeLabel'><i class='icon-remove icon-pointer' onclick='placeArray.cleanArrayByLocation("+results[0].geometry.location.Ya+","+results[0].geometry.location.Xa+");$(\"#placeForm #placeInput\").val(JSON.stringify(placeArray));$(this).parent().remove();'></i> "+results[0].formatted_address+"</div>");
							
						} else {
							var salt = new Date().getTime();
							$('#placeForm #btn-place-adder').parent().before("<div id='alert"+salt+"' class='control-label'><i class='icon-exclamation-sign'> </i>Adresse invalide ("+status+")</div>");
							setTimeout(function() {
								$("#alert"+salt).fadeOut();
							}, 3000);
							$('#placeForm #place').select();
						}
					});
				}		
			});

			/*
			$.getJSON('/api/unvalidatedPlaceList', function(data) {
				renderData(data);
			});
			*/
			
		});/*END READY*/

		function drawNewsFeed(){	
			var newsfeedContainerHeight = window.innerHeight-$('#newsfeedContainer').offset().top-50+'px';
			$('#newsfeedContainer').css('height',newsfeedContainerHeight);
		}
		
		function unhighlightInfo(obj,callback){
			markerHL.setAnimation(null);
			markerHL.setVisible(false);
			
			if (callback && typeof(callback) === "function") {  
				callback(obj);  
			} 
		}
		
		function highlightInfo(obj){
			var id = obj.attr('infoId');
			
			$.each(infoArray,function(key,val){
				//console.log(val2._id+' == '+val._id);
				if(val._id == id){
					// hide all markers
					//hideMarkers(7000);
					
					// clean if a marker is already highlighted
						
					var latLng = new google.maps.LatLng(val.location['lat'],val.location['lng']);
					markerHL.setPosition(latLng);
					markerHL.setVisible(true);
					markerHL.setMap(map);
					markerHL.setAnimation(google.maps.Animation.BOUNCE);
					markerHL.setOptions({icon:"/images/markers/type"+val.yakType+".png"});
					
					//$("ul#newsfeed li.mapHighlighterDetails").fadeOut().html('');
					//$("ul#newsfeed li.mapHighlighterDetails[infoid="+id+"]").fadeIn();
				
					// center map
					map.setCenter(latLng);
					
					
					// clear marker ( and infowindow )
					setTimeout(function() {
						
						//markerHL.setAnimation(null);
						//markerHL.setVisible(false);
						markerHL.setMap(null);
						
					}, 2000);
				}
			});
		}

		function initialize(x,y,z){

			// set user cookies
			$.cookie("geoloc", JSON.stringify(curPos),{ expires: 10000 });
			//console.log(JSON.parse($.cookie("geoloc")));
			
			var center = new google.maps.LatLng(x,y);
			infowindow = new google.maps.InfoWindow({content: ".",maxWidth : 300});
			map = new google.maps.Map(document.getElementById('mymap'), {
				zoom: z,
				center: center,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			});
			
			markerClustererOptions = {gridSize:30,maxZoom: 17};
			markerCluster = new MarkerClusterer(map, markers,markerClustererOptions);
				
			markerHL = new google.maps.Marker({position: center,map:map,visible:false});
			
			google.maps.event.addListenerOnce(map, 'idle', function(){
				bounds = this.getBounds();
				getAndPrintInfo();
				
			});
			
			
			google.maps.event.addListener(map, 'dragend', function() {
				bounds = this.getBounds();
				center = this.getCenter();
				curPos.x = center.lat();
				curPos.y = center.lng();
				$.cookie("geoloc", JSON.stringify(curPos));
				getAndPrintInfo();
			});
			
			google.maps.event.addListener(map, 'zoom_changed', function() {
				bounds = this.getBounds();	
				curPos.z = this.getZoom();
				$.cookie("geoloc", JSON.stringify(curPos));
				getAndPrintInfo();
			});
			
			
			
		}
		
		function cleanMarkers(){
		// clean existing markers
			$.each(markers,function(key,val){
					val.setMap(null);
			});
			
			markers = [];
			markerCluster.clearMarkers();
		}
		
		function hideMarkers(ms){
		//console.log('hide');
		// hide existing markers for ms milisec
			markerCluster.clearMarkers();
			$.each(markers,function(key,val){
					val.setVisible(false);
			});
			setInterval(function() {
				$.each(markers,function(key,val){
					val.setVisible(true);
				});
				markerCluster.addMarkers(markers);
			}, ms);
			
		}
		
		function silentMarkerAdder(){
			//console.log('silentMarkerAdder');
			$.getJSON('/api/geoinfos/'+bounds.ca.b+'/'+bounds.ea.b+'/'+bounds.ca.f+'/'+bounds.ea.f+'/'+heat+'/'+type.toString(),function(data) {
				
				$.each(data.info, function(key,val) {
					
					
					
					var flagExists = 0;
					
					$.each(infoArray,function(key2,val2){
						//console.log(val2._id+' == '+val._id);
						if(val2._id == val._id){
							flagExists = 1;
							//console.log('EQ');
						}
					});
					
					//console.log(infoArray.length+' '+data.info.length);
					//console.log('exisits'+flagExists);
					if(flagExists == 0){
						//console.log('PRINT NEW MARKER');
						
						var uniqueHL = new Date().getTime();
						
						var dateTmp = new Date(val.pubDate);
						var dateCreation = dateTmp.getDate()+'/'+(dateTmp.getMonth()+1)+'/'+dateTmp.getFullYear();
						infoContent = "<div class=\'infowindow mapHighlighter\' infoId='"+val._id+"'>";
						if(!(typeof val.thumb === 'undefined') && val.thumb != ''){
						if(val.user == 0 || val.user === undefined)
								infoContent += "<img src=\'"+conf.backurl+val.thumb+"\' />";
							else
								infoContent += "<img src=\'/uploads/pictures/120_90/"+val.thumb+"\' />";
						}
						infoContent += "<div class=\'title\'> "+val.title.replace(rule2,'')+" ("+dateCreation+")";
						infoContent += "</div>";
						infoContent += "<div class=\'content\'>"+val.content.substring(0,250).replace(rule2,'')+"...</div>";
						if(!(typeof val.outGoingLink === 'undefined'))
							infoContent += "<div class=\'readmore\'><a target=\'_blank\' href=\'"+val.outGoingLink+"\'> >> lire l\'article</a></div>";
						
						infoContent += "</div>";
						
						/*PRINT ON THE MAP*/
						var latLng = new google.maps.LatLng(val.location['lat'],val.location['lng']);
						var marker = new google.maps.Marker({position: latLng,map:map,visible:true,icon:"/images/markers/type"+val.yakType+".png"});
						
						marker.setAnimation(google.maps.Animation.BOUNCE);
						
						
						setTimeout(function() {
							marker.setAnimation(null);
							markerCluster.addMarker(marker);
							
						}, 7000);
						
						/*PRINT ON THE FEED*/
						$('#newsfeed').prepend('<li class=\'mapHighlighterDetails\' infoId=\''+val._id+'\' >'+infoContent+'</li>');	


						
						google.maps.event.addListener(marker, 'click', function() {
						
								$("#newsfeed li").removeClass('highlighted');
								$("#newsfeed li[infoId=\""+val._id+"\"]").addClass('highlighted');
								$('#newsfeedContainer').mCustomScrollbar("scrollTo",".mapHighlighter[infoId=\""+val._id+"\"]");
								
								/*
								var dateTmp = new Date(val.pubDate);
								var dateCreation = dateTmp.getDate()+'/'+(dateTmp.getMonth()+1)+'/'+dateTmp.getFullYear();
								infoContent = "<div class=\'infowindow\' >";
								if(!(typeof val.thumb === 'undefined') && val.thumb != ''){
								if(val.user == 0 || val.user === undefined)
										infoContent += "<img src=\'"+conf.backurl+val.thumb+"\' />";
									else
										infoContent += "<img src=\'/uploads/pictures/120_90/"+val.thumb+"\' />";
								}
								infoContent += "<div class=\'title\'> "+val.title.replace(rule2,'')+" ("+dateCreation+")";
								if(!(typeof val.outGoingLink === 'undefined'))
									infoContent += "<div class=\'readmore\'><a target=\'_blank\' href=\'"+val.outGoingLink+"\'> >> lire l\'article</a></div>";
								infoContent += "</div>";
								infoContent += "<div class=\'content\'>"+val.content.substring(0,250).replace(rule2,'')+"...</div>";
								infoContent += "</div>";
								infowindow.setContent(infoContent);
								infowindow.open(map, this);
								*/
							});	
						
							
							
						
						infoArray.push(val);	
						
						
						
					}
				});
			});
		}
		
		function getAndPrintInfo(){
			
			
			drawNewsFeed();
			
			cleanMarkers();
			
		
			$.getJSON('/api/geoinfos/'+bounds.ca.b+'/'+bounds.ea.b+'/'+bounds.ca.f+'/'+bounds.ea.f+'/'+heat+'/'+type.toString(),function(data) {
				
				// empty the news feed
				if(data.info.length == 0)
					$('#newsfeed').html('Aucune info !');
				else
					$('#newsfeed').html('');
				
				
				$.each(data.info, function(key,val) {
				
					
					/*PRINT ON THE MAP*/	
					
					//console.log(val.location);
					infoArray.push(val);
					var latLng = new google.maps.LatLng(val.location['lat'],val.location['lng']);
					var marker = new google.maps.Marker({position: latLng,icon:"/images/markers/type"+val.yakType+".png"});
					markers.push(marker);
					//console.log(markers);
					
					var dateTmp = new Date(val.pubDate);
					var dateCreation = dateTmp.getDate()+'/'+(dateTmp.getMonth()+1)+'/'+dateTmp.getFullYear();
					infoContent = "<div class=\'infowindow mapHighlighter\' infoId='"+val._id+"'>";
					if(!(typeof val.thumb === 'undefined') && val.thumb != ''){
					if(val.user == 0 || val.user === undefined)
							infoContent += "<img src=\'"+conf.backurl+val.thumb+"\' />";
						else
							infoContent += "<img src=\'/uploads/pictures/120_90/"+val.thumb+"\' />";
					}
					infoContent += "<div class=\'title\'> "+val.title.replace(rule2,'')+" ("+dateCreation+")";
					infoContent += "</div>";
					infoContent += "<div class=\'content\'>"+val.content.substring(0,250).replace(rule2,'')+"...</div>";
					if(!(typeof val.outGoingLink === 'undefined'))
						infoContent += "<div class=\'readmore\'><a target=\'_blank\' href=\'"+val.outGoingLink+"\'> >> lire l\'article</a></div>";
					infoContent += "<div>"+val.address+"</div>";
					infoContent += "</div>";
					
					/*PRINT ON THE FEED*/
					//$('#newsfeed').append('<li class=\'mapHighlighter\' infoId=\''+val._id+'\'><i class=\'icon-eye-open\' ></i> '+val.title+'</li>')
					$('#newsfeed').append('<li class=\'mapHighlighterDetails\' infoId=\''+val._id+'\' >'+infoContent+'</li>');
					
					
					google.maps.event.addListener(marker, 'click', function() {
					
						$("#newsfeed li").removeClass('highlighted');
						$("#newsfeed li[infoId=\""+val._id+"\"]").addClass('highlighted');
						$('#newsfeedContainer').mCustomScrollbar("scrollTo",".mapHighlighter[infoId=\""+val._id+"\"]");
						
						
					/*	var dateTmp = new Date(val.pubDate);
						var dateCreation = dateTmp.getDate()+'/'+(dateTmp.getMonth()+1)+'/'+dateTmp.getFullYear();
						infoContent = "<div class=\'infowindow\' >";
						if(!(typeof val.thumb === 'undefined') && val.thumb != ''){
						if(val.user == 0 || val.user === undefined)
								infoContent += "<img src=\'"+conf.backurl+val.thumb+"\' />";
							else
								infoContent += "<img src=\'/uploads/pictures/120_90/"+val.thumb+"\' />";
						}
						infoContent += "<div class=\'title\'> "+val.title.replace(rule2,'')+" ("+dateCreation+")";
						if(!(typeof val.outGoingLink === 'undefined'))
							infoContent += "<div class=\'readmore\'><a target=\'_blank\' href=\'"+val.outGoingLink+"\'> >> lire l\'article</a></div>";
						infoContent += "</div>";
						infoContent += "<div class=\'content\'>"+val.content.substring(0,250).replace(rule2,'')+"...</div>";
						infoContent += "</div>";
						infowindow.setContent(infoContent);
						infowindow.open(map, this);*/
					
					});	
					
					
				
					
					
				});
				
				markerCluster.clearMarkers();
				markerCluster.addMarkers(markers);
				
			});
		
		}